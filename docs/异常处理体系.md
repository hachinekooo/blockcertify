# ä¼ä¸šçº§åŒºå—é“¾å­˜è¯ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ

> ä¸€å¥—å®Œæ•´çš„åŒºå—é“¾å­˜è¯ç³»ç»Ÿï¼Œä¸ºä¸šåŠ¡ç³»ç»Ÿæä¾›**é›¶ä¾µå…¥ã€é«˜å¯ç”¨**çš„æ•°æ®å­˜è¯èƒ½åŠ›

---

## ğŸ¯ æ ¸å¿ƒä»·å€¼

**ä¸šåŠ¡ä»£ç æ— æ„ŸçŸ¥** - åªéœ€æ·»åŠ æ³¨è§£ï¼Œè‡ªåŠ¨å®Œæˆå­˜è¯æµç¨‹
**å¤šå‚å•†é€‚é…** - æ”¯æŒèš‚èšé“¾ã€è…¾è®¯é“¾ã€ä»¥å¤ªåŠç­‰ä¸»æµåŒºå—é“¾
**å¼‚æ­¥é«˜å¯é ** - å­˜è¯å¤±è´¥ä¸å½±å“ä¸»ä¸šåŠ¡ï¼Œå†…ç½®æ™ºèƒ½é‡è¯•
**ç”Ÿäº§å°±ç»ª** - å®Œæ•´çš„ç›‘æ§ã€å‘Šè­¦å’Œé™çº§æœºåˆ¶

---

## âš¡ å¿«é€Ÿæ¥å…¥

```java
@BlockchainCertify(bizType = "userAction")
@Transactional
public void registerUser(User user) {
    userService.save(user);
    // AOPè‡ªåŠ¨æˆªå–æ•°æ®å¹¶å­˜è¯åˆ°åŒºå—é“¾
}
```

**ä¸‰æ­¥æ¥å…¥**ï¼š
1. æ·»åŠ  `@BlockchainCertify` æ³¨è§£
2. é…ç½®æ•°æ®æå–ç­–ç•¥
3. å¯ç”¨åŒºå—é“¾åŠŸèƒ½

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ä¸šåŠ¡å±‚                   â”‚
â”‚  @BlockchainCertify              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ AOPåˆ‡é¢
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å­˜è¯å¼•æ“                  â”‚
â”‚  â€¢ å¼‚æ­¥å¤„ç†                    â”‚
â”‚  â€¢ çŠ¶æ€ç®¡ç†                    â”‚
â”‚  â€¢ é‡è¯•æœºåˆ¶                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        åŒºå—é“¾å®¢æˆ·ç«¯               â”‚
â”‚  â€¢ å¤šå‚å•†æŠ½è±¡                  â”‚
â”‚  â€¢ è¿æ¥ç®¡ç†                    â”‚
â”‚  â€¢ è¶…æ—¶æ§åˆ¶                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å¼‚å¸¸ä½“ç³»
```
BuddyBooksException (æ¥å£æ ‡å‡†)
â””â”€â”€ CertifyException (æŠ½è±¡åŸºç±»)
    â”œâ”€â”€ BusinessException (ä¸šåŠ¡å¼‚å¸¸)
    â”œâ”€â”€ SystemException (ç³»ç»Ÿå¼‚å¸¸)
    â”œâ”€â”€ ThirdPartyException (ç¬¬ä¸‰æ–¹å¼‚å¸¸)
    â””â”€â”€ ConcurrentLimitException (å¹¶å‘é™åˆ¶)
```

**æ¯ä¸ªå¼‚å¸¸åŒ…å«**ï¼š
- é”™è¯¯ç  (1000-8999 åˆ†ç±»ç®¡ç†)
- ä¸¥é‡ç¨‹åº¦ (LOW/MEDIUM/HIGH/CRITICAL)
- é‡è¯•ç­–ç•¥ (æ™ºèƒ½é‡è¯•æœºåˆ¶)
- ç”¨æˆ·æ¶ˆæ¯ (å‹å¥½çš„é”™è¯¯æç¤º)

---

## ğŸ›¡ï¸ å¯é æ€§ä¿éšœ

### å¤šå±‚å®¹é”™æœºåˆ¶
```java
// 1. å‚æ•°é¢„éªŒè¯
ExceptionValidator.notNull(certifyData, "certifyData");

// 2. çŠ¶æ€æ£€æŸ¥
ExceptionValidator.stateEquals(blockchainClient.getStatus(),
                              ClientStatusEnum.CONNECTED,
                              "åŒºå—é“¾å®¢æˆ·ç«¯è¿æ¥çŠ¶æ€");

// 3. å¼‚å¸¸æ¢å¤
.exceptionally(ex -> {
    certifyService.updateRecordStatus(recordId, FAILED);
    return createFailedResult(ex);
})
```

### æ™ºèƒ½é‡è¯•ç­–ç•¥
```java
// ç³»ç»Ÿå¼‚å¸¸: è‡ªåŠ¨é‡è¯•
RetryPolicy.of(3, Duration.ofSeconds(60));

// ä¸šåŠ¡å¼‚å¸¸: ä¸é‡è¯•
RetryPolicy.disabled();

// é…ç½®é”™è¯¯: ç«‹å³å¤±è´¥
RetryPolicy.disabled();
```

---

## ğŸ“Š ç›‘æ§ä½“ç³»

### å®æ—¶ç›‘æ§
- **å¼‚å¸¸æŒ‡æ ‡**: æŒ‰ç±»å‹ã€ä¸¥é‡ç¨‹åº¦ç»Ÿè®¡
- **å¤„ç†è€—æ—¶**: ç›‘æ§å¼‚å¸¸å¤„ç†æ€§èƒ½
- **æˆåŠŸç‡**: å­˜è¯æˆåŠŸç‡å®æ—¶è·Ÿè¸ª
- **é“¾è·¯è¿½è¸ª**: åˆ†å¸ƒå¼è¯·æ±‚å…¨é“¾è·¯è·Ÿè¸ª

### åˆ†çº§å‘Šè­¦
- **CRITICAL**: ç«‹å³å‘Šè­¦ï¼Œæ ¸å¿ƒåŠŸèƒ½å—å½±å“
- **HIGH**: 5åˆ†é’Ÿå‘Šè­¦ï¼Œé‡è¦åŠŸèƒ½å¼‚å¸¸
- **MEDIUM**: 1å°æ—¶æ±‡æ€»å‘Šè­¦
- **LOW**: æ—¥æŠ¥çº§åˆ«å‘Šè­¦

---

## ğŸš€ éƒ¨ç½²é…ç½®

### åº”ç”¨é…ç½®
```yaml
blockchain:
  enabled: true                # å¯ç”¨å­˜è¯åŠŸèƒ½
  provider: antchain            # åŒºå—é“¾å‚å•†
  timeout: 30s                # è¶…æ—¶æ—¶é—´
  retry:
    max-attempts: 3            # æœ€å¤§é‡è¯•æ¬¡æ•°
    backoff: 60s              # é‡è¯•é—´éš”
```

### Spring Boot é›†æˆ
```java
@SpringBootApplication
@EnableBlockchainCertify  // å¯ç”¨å­˜è¯åŠŸèƒ½
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### å¼‚æ­¥å¤„ç†
- **ä¸»ä¸šåŠ¡** å­˜è¯å¼‚æ­¥æ‰§è¡Œï¼Œä¸é˜»å¡ä¸»æµç¨‹
- **çŠ¶æ€è¿½è¸ª** å®æ—¶è·Ÿè¸ªå­˜è¯çŠ¶æ€å˜åŒ–
- **å¤±è´¥é‡è¯•** æ™ºèƒ½é‡è¯•æœºåˆ¶ï¼Œæå‡æˆåŠŸç‡

### å†…å­˜ä¼˜åŒ–
- **å¯¹è±¡æ± ** å¤ç”¨é¢‘ç¹åˆ›å»ºçš„å¯¹è±¡
- **æ‰¹é‡å¤„ç†** æ”¯æŒæ‰¹é‡å­˜è¯ï¼Œæå‡ååé‡
- **è¿æ¥å¤ç”¨** åŒºå—é“¾å®¢æˆ·ç«¯è¿æ¥æ± ç®¡ç†

---

## ğŸ”§ æ‰©å±•èƒ½åŠ›

### æ”¯æŒçš„åŒºå—é“¾å‚å•†
- **èš‚èšé“¾** - èš‚èšé‡‘æœåŒºå—é“¾æœåŠ¡
- **è…¾è®¯é“¾** - è…¾è®¯åŒºå—é“¾æœåŠ¡
- **ä»¥å¤ªåŠ** - å…¬æœ‰é“¾ä»¥å¤ªåŠç½‘ç»œ
- **è‡ªå®šä¹‰** - æ”¯æŒæ‰©å±•å…¶ä»–åŒºå—é“¾å‚å•†

### æ•°æ®æå–ç­–ç•¥
- **æ³¨è§£é©±åŠ¨** - åŸºäºæ³¨è§£æå–ä¸šåŠ¡æ•°æ®
- **é…ç½®åŒ–** - æ”¯æŒåŠ¨æ€é…ç½®æå–è§„åˆ™
- **æ’ä»¶åŒ–** - æ”¯æŒè‡ªå®šä¹‰æ•°æ®æå–æ’ä»¶

---

## ğŸ¯ æœ€ä½³å®è·µ

### ä¸šåŠ¡æ¥å…¥å»ºè®®
1. **æ˜ç¡®ä¸šåŠ¡è¾¹ç•Œ** - åªå¯¹å…³é”®ä¸šåŠ¡æ•°æ®è¿›è¡Œå­˜è¯
2. **åˆç†è®¾ç½®é‡è¯•** - æ ¹æ®ä¸šåŠ¡é‡è¦æ€§é…ç½®é‡è¯•ç­–ç•¥
3. **ç›‘æ§å¼‚å¸¸** - å…³æ³¨å¼‚å¸¸è¶‹åŠ¿ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
4. **æµ‹è¯•éªŒè¯** - å……åˆ†æµ‹è¯•å¼‚å¸¸åœºæ™¯å’Œæ¢å¤æœºåˆ¶

### è¿ç»´ç›‘æ§
1. **è®¾ç½®å‘Šè­¦é˜ˆå€¼** - æ ¹æ®ä¸šåŠ¡å®¹å¿åº¦é…ç½®å‘Šè­¦
2. **å®šæœŸå·¡æ£€** - æ£€æŸ¥åŒºå—é“¾è¿æ¥çŠ¶æ€å’Œç§¯å‹æƒ…å†µ
3. **å®¹é‡è§„åˆ’** - æ ¹æ®ä¸šåŠ¡å¢é•¿é¢„æµ‹åŒºå—é“¾èµ„æºéœ€æ±‚
4. **æ•…éšœæ¼”ç»ƒ** - å®šæœŸæ¼”ç»ƒå¼‚å¸¸åœºæ™¯çš„å¤„ç†æµç¨‹

---

## ğŸ“š ç¤ºä¾‹ä»£ç 

### åŸºæœ¬å­˜è¯
```java
@Service
public class UserService {

    @BlockchainCertify(bizType = "userRegister")
    public void registerUser(UserDTO dto) {
        User user = convertToEntity(dto);
        userRepository.save(user);
        // AOPè‡ªåŠ¨å­˜è¯ç”¨æˆ·æ³¨å†Œäº‹ä»¶
    }
}
```

### è‡ªå®šä¹‰æ•°æ®æå–
```java
@Component
public class UserDataExtractor implements DataExtractor {

    @Override
    public CertifyData extract(Object[] args) {
        User user = (User) args[0];
        return CertifyData.builder()
                .businessId(user.getId())
                .content(user.toString())
                .businessType("userRegister")
                .build();
    }
}
```

### å¼‚å¸¸å¤„ç†
```java
@RestController
public class UserController {

    @PostMapping("/register")
    public ApiResponse register(@RequestBody UserDTO dto) {
        try {
            userService.registerUser(dto);
            return ApiResponse.success();
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸ï¼Œè¿”å›ç”¨æˆ·å‹å¥½æç¤º
            return ApiResponse.error(e.getUserMessage());
        } catch (SystemException e) {
            // ç³»ç»Ÿå¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—å¹¶è¿”å›é€šç”¨æç¤º
            log.error("ç”¨æˆ·æ³¨å†Œå¤±è´¥", e);
            return ApiResponse.error("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        }
    }
}
```

---

**ğŸ‰ é€šè¿‡è¿™å¥—è®¾è®¡æ–¹æ¡ˆï¼Œä¸šåŠ¡ç³»ç»Ÿå¯ä»¥è½»æ¾è·å¾—ä¼ä¸šçº§çš„åŒºå—é“¾å­˜è¯èƒ½åŠ›ï¼Œè®©æ•°æ®å¯ä¿¡å­˜å‚¨å˜å¾—ç®€å•å¯é ï¼**